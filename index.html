<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>FinLoan System</title>
<style>
body{font-family:Arial;background:#f4f6fb;margin:0}
.header{background:#1d2671;color:#fff;padding:15px;text-align:center;font-weight:bold}
.container{max-width:450px;margin:20px auto;padding:15px}
.card{background:#fff;padding:15px;border-radius:12px;margin-bottom:15px;box-shadow:0 5px 15px rgba(0,0,0,0.08)}
input,select,button{width:100%;padding:12px;margin:8px 0;border-radius:8px;border:1px solid #ccc}
button{background:#0072ff;color:#fff;border:none;font-weight:bold}
.loan{background:#eef;padding:8px;border-radius:8px;margin:5px 0;font-size:14px}
</style>
</head>
<body>

<div class="header">FinLoan Admin & User System</div>
<div class="container">

<div id="authBox" class="card">
  <h3>Đăng nhập / Đăng ký</h3>
  <input id="email" placeholder="Email">
  <input id="pass" type="password" placeholder="Mật khẩu">
  <button onclick="register()">Đăng ký</button>
  <button onclick="login()">Đăng nhập</button>
</div>

<div id="userApp" style="display:none">
  <div class="card">
    <h3>Đăng ký khoản vay</h3>
    <input id="money" type="number" placeholder="Số tiền vay">
    <input type="file" id="cccd">
    <button onclick="sendLoan()">Gửi yêu cầu</button>
  </div>

  <div class="card">
    <h3>Lịch sử vay</h3>
    <div id="history"></div>
  </div>
</div>

<div id="adminApp" style="display:none" class="card">
  <h3>ADMIN - Danh sách khoản vay</h3>
  <div id="allLoans"></div>
</div>

</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const firebaseConfig = {
  // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAMVMlleglI5teSX_wnH74MByezCeJAqqU",
  authDomain: "tambeo-b465a.firebaseapp.com",
  projectId: "tambeo-b465a",
  storageBucket: "tambeo-b465a.firebasestorage.app",
  messagingSenderId: "756559820351",
  appId: "1:756559820351:web:a30b3d8f9596ad5c1baa8a",
  measurementId: "G-PE3QY00VX4"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();
const storage = getStorage();

const ADMIN_EMAIL = "admin@gmail.com"; // đổi thành email admin

window.register = () => createUserWithEmailAndPassword(auth,email.value,pass.value);
window.login = () => signInWithEmailAndPassword(auth,email.value,pass.value);

onAuthStateChanged(auth, user => {
  if(user){
    authBox.style.display="none";
    userApp.style.display="block";
    loadHistory(user);

    if(user.email===ADMIN_EMAIL){
      adminApp.style.display="block";
      loadAllLoans();
    }
  }
});

window.sendLoan = async () => {
  const user = auth.currentUser;
  const file = cccd.files[0];
  const storageRef = ref(storage, "cccd/"+Date.now()+file.name);
  await uploadBytes(storageRef, file);
  const url = await getDownloadURL(storageRef);

  await addDoc(collection(db,"loans"),{
    uid:user.uid,
    email:user.email,
    money:money.value,
    cccd:url,
    time:new Date().toLocaleString()
  });

  alert("Đã gửi yêu cầu vay!");
  loadHistory(user);
};

async function loadHistory(user){
  history.innerHTML="";
  const q=query(collection(db,"loans"),where("uid","==",user.uid));
  const snap=await getDocs(q);
  snap.forEach(doc=>{
    let d=doc.data();
    history.innerHTML+=`<div class="loan">${d.money} VNĐ - ${d.time}</div>`;
  });
}

async function loadAllLoans(){
  const snap=await getDocs(collection(db,"loans"));
  snap.forEach(doc=>{
    let d=doc.data();
    allLoans.innerHTML+=`<div class="loan">${d.email} vay ${d.money} - <a href="${d.cccd}" target="_blank">Xem CCCD</a></div>`;
  });
}
</script>

</body>
</html>
