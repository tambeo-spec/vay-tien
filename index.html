<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Hệ thống vay tiền</title>
  <style>
    body { font-family: Arial; padding:20px; max-width:500px; margin:auto }
    input, button { width:100%; padding:10px; margin:5px 0 }
    .box { border:1px solid #ccc; padding:10px; margin:10px 0 }
  </style>
</head>
<body>

<h2>Đăng nhập / Đăng ký</h2>
<input type="email" id="email" placeholder="Email">
<input type="password" id="password" placeholder="Mật khẩu">
<button onclick="register()">Đăng ký</button>
<button onclick="login()">Đăng nhập</button>
<button onclick="logout()">Đăng xuất</button>

<hr>

<h2>Gửi yêu cầu vay</h2>
<input type="text" id="name" placeholder="Họ tên">
<input type="number" id="money" placeholder="Số tiền vay">
<input type="file" id="cccd">
<button onclick="sendLoan()">Gửi hồ sơ</button>

<h3>Lịch sử vay</h3>
<div id="history"></div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, addDoc, query, where, getDocs } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyAMVMlleglI5teSX_wnH74MByezCeJAqqU",
  authDomain: "tambeo-b465a.firebaseapp.com",
  projectId: "tambeo-b465a",
  storageBucket: "tambeo-b465a.firebasestorage.app",
  messagingSenderId: "756559820351",
  appId: "1:756559820351:web:a30b3d8f9596ad5c1baa8a"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// REGISTER
window.register = () => {
  createUserWithEmailAndPassword(auth, email.value, password.value)
  .then(()=>alert("Đăng ký thành công"))
  .catch(e=>alert(e.message));
}

// LOGIN
window.login = () => {
  signInWithEmailAndPassword(auth, email.value, password.value)
  .then(()=>alert("Đăng nhập thành công"))
  .catch(e=>alert(e.message));
}

// LOGOUT
window.logout = () => signOut(auth)

// GỬI HỒ SƠ VAY
window.sendLoan = async () => {
  const user = auth.currentUser;
  if(!user) return alert("Bạn chưa đăng nhập");

  const file = cccd.files[0];
  if(!file) return alert("Chưa chọn ảnh CCCD");

  const storageRef = ref(storage, "cccd/" + user.uid + Date.now());
  await uploadBytes(storageRef, file);
  const url = await getDownloadURL(storageRef);

  await addDoc(collection(db, "loans"), {
    uid: user.uid,
    name: name.value,
    money: Number(money.value),
    cccd: url,
    status: "Chờ duyệt",
    time: new Date()
  });

  alert("Đã gửi hồ sơ!");
  loadHistory();
}

// LOAD LỊCH SỬ
async function loadHistory() {
  const user = auth.currentUser;
  if(!user) return;

  const q = query(collection(db,"loans"), where("uid","==",user.uid));
  const snap = await getDocs(q);

  history.innerHTML = "";
  snap.forEach(doc=>{
    const d = doc.data();
    history.innerHTML += `
      <div class="box">
        <b>${d.name}</b><br>
        Số tiền: ${d.money} VND<br>
        Trạng thái: <b>${d.status}</b>
      </div>`;
  });
}

onAuthStateChanged(auth, u => { if(u) loadHistory(); });

</script>
</body>
</html>
